[build]
  base = "netlify_base"
  publish = "apps/lunarswap-ui/.next"
  command = """
  set -euo pipefail
  corepack enable
  corepack prepare pnpm@10.4.1 --activate

  cd ..  # repo root

  # 1) compactc where code expects it
  COMPACT_HOME="$PWD/packages/compact/compactc"
  mkdir -p "$COMPACT_HOME"
  V=0.23.0
  ZIP="compactc_v${V}_x86_64-unknown-linux-musl.zip"
  URL="https://d3fazakqrumx6p.cloudfront.net/artifacts/compiler/compactc_${V}/${ZIP}"
  curl -Ls "$URL" -o "$COMPACT_HOME/compactc.zip"
  unzip -qo "$COMPACT_HOME/compactc.zip" -d "$COMPACT_HOME"
  chmod +x "$COMPACT_HOME"/{compactc,compactc.bin,zkir}
  export COMPACT_HOME PATH="$COMPACT_HOME:$PATH"
  "$COMPACT_HOME/compactc" --version

  # 2) Install workspace deps at root level WITH --ignore-scripts
  pnpm -w install --frozen-lockfile --prefer-offline --ignore-scripts

  # 3) Install compact package dependencies specifically (without workspace bin linking)
  cd packages/compact
  pnpm install --prefer-offline --ignore-scripts
  
  # 4) Build compact package (now its deps are available)
  pnpm run build
  test -f dist/runCompiler.js || { echo "runCompiler.js not found!"; exit 1; }
  test -f dist/runBuilder.js || { echo "runBuilder.js not found!"; exit 1; }
  cd ../../

  # 5) Rebuild to link all bins now that compact files exist
  pnpm -w rebuild -r

  # 6) Build everything else + Next app
  pnpm -w -r --workspace-concurrency=1 run build
  cd apps/lunarswap-ui
  pnpm run build
  """

[build.environment]
  NODE_VERSION = "22"
  PNPM_VERSION = "10.4.1"
